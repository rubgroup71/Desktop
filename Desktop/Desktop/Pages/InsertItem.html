<!DOCTYPE html>
<html lang="en">
<head>
    <title></title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.3/css/responsive.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href=" https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/responsive/2.2.3/js/dataTables.responsive.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="../Scripts/ajaxCalls.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.9.2/firebase-app.js"></script>

    <!-- Add additional services that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/5.9.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.9.2/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.9.2/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.9.2/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.9.2/firebase-functions.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.9.2/firebase.js"></script>

    <script src="../Scripts/fbconfig.js"></script>
    <script>
        fbconfig()
    </script>
    <style>



        @import url('https://fonts.googleapis.com/css?family=Roboto+Condensed:400,700');

        table.dataTable tbody th, table.dataTable tbody td {
            padding: 6px 70px 0px 10px;
            text-align: left;
            float: unset;
            color: black;
        }

        body {
            background: url('http://all4desktop.com/data_images/original/4236532-background-images.jpg');
            font-family: 'Roboto Condensed', sans-serif;
            color: #262626;
            margin: 5% 0;
        }

        .container {
            width: 100%;
            padding-right: 15px;
            padding-left: 15px;
            margin-right: auto;
            margin-left: auto;
        }

        @media (min-width: 1200px) {
            .container {
                max-width: 1140px;
            }
        }

        .d-flex {
            display: flex;
            flex-direction: row;
            background: #f6f6f6;
            border-radius: 0 0 5px 5px;
            padding: 25px;
        }

        form {
            flex: 4;
        }

        .Yorder {
            flex: 2;
        }

        .title {
            background: -webkit-gradient(linear, left top, right bottom, color-stop(0, #5195A8), color-stop(100, #70EAFF));
            background: -moz-linear-gradient(top left, #5195A8 0%, #70EAFF 100%);
            background: -ms-linear-gradient(top left, #5195A8 0%, #70EAFF 100%);
            background: -o-linear-gradient(top left, #5195A8 0%, #70EAFF 100%);
            background: linear-gradient(to bottom right, #5195A8 0%, #70EAFF 100%);
            border-radius: 5px 5px 0 0;
            padding: 20px;
            color: #f6f6f6;
        }

        h2 {
            margin: 0;
            padding-left: 15px;
        }

        .required {
            color: red;
        }



        label > span {
            float: left;
            width: 25%;
            margin-top: 12px;
            padding-right: 10px;
        }

        input[type="text"], input[type="tel"], input[type="email"], select {
            width: 70%;
            height: 30px;
            padding: 5px 10px;
            margin-bottom: 10px;
            border: 1px solid #dadada;
            color: #888;
        }

        select {
            width: 72%;
            height: 45px;
            padding: 5px 10px;
            margin-bottom: 10px;
        }

        /*.Yorder {
            margin-top: 15px;
            height: 600px;
            padding: 20px;
            border: 1px solid #dadada;
        }*/

        table {
            margin: 0;
            padding: 0;
        }

        th {
            border-bottom: 1px solid #dadada;
            padding: 10px 0;
        }

        tr > td:nth-child(1) {
            text-align: left;
            color: #2d2d2a;
        }

        tr > td:nth-child(2) {
            text-align: right;
            color: #52ad9c;
        }

        td {
            border-bottom: 1px solid #dadada;
            padding: 25px 25px 25px 0;
        }

        p {
            display: block;
            color: #888;
            margin: 0;
            padding-left: 25px;
        }

        .Yorder > div {
            padding: 15px 0;
        }

        button {
            width: 40%;
            margin-top: 10px;
            padding: 10px;
            border: none;
            border-radius: 30px;
            background: #52ad9c;
            color: #fff;
            font-size: 10px;
            font-weight: bold;
        }

            button:hover {
                cursor: pointer;
                background: #428a7d;
            }



        .fab {
            width: 70px;
            height: 70px;
            background-color: red;
            border-radius: 50%;
            box-shadow: 0 6px 10px 0 #666;
            transition: all 0.1s ease-in-out;
            font-size: 50px;
            color: white;
            text-align: center;
            line-height: 70px;
            position: fixed;
            right: 50px;
            bottom: 50px;
        }

            .fab:hover {
                box-shadow: 0 6px 14px 0 #666;
                transform: scale(1.05);
            }

        .wrapper {
            display: grid;
            grid-template-columns: 10% 10% 10% 10% 10% 10% 10% 10% 10% 10%;
            grid-template-rows: 5%;
            grid-gap: 10px;
            grid-row: 1;
        }

        .item {
            font-weight: bold;
        }
    </style>
    <script>
        var tree = [];
        var docids = []
        var standardtree = [];
        var db = firebase.firestore();
        $(document).ready(function () {

            ajaxCall("GET", "../api/AllItem", "", successGetstage, errorGetstage);
            db.collection("tmp").orderBy('id', 'asc').get().then(function (querySnapshot) {
                querySnapshot.forEach(function (doc) {
                    docids.push(doc.id)
                    tree.push(doc.data());
                });

                console.log(tree, tree.length)

            });

            db.collection("standard").orderBy('id', 'asc').get().then(function (querySnapshot) {
                querySnapshot.forEach(function (doc) {

                    standardtree.push(doc.data());
                });

                console.log(standardtree)

            });


        });

        function add() {
            var tmp = [];
            var choose = [];
            for (var i = 1; i < 11; i++) {
                tmp = [];
                $.each($("input[name='stage" + i + "']:checked"), function () {
                    tmp.push($(this).val());
                });


                if (i == 1) {
                    choose.push({ id: i.toString(), parent: '', value: tmp });
                }
                else {

                    choose.push({ id: i.toString(), parent: parent, value: tmp });
                }

                var parent = choose[i - 1].value

            }


            fusion(choose)

        };

        function fusion(choose) {
            var addnew = false
            var updateparent = false
            var updatevalue = false
            var valtoparent = []
            var valtovalue = []
            var emptytree = false
            if (tree.length == 0) {
                emptytree = true
                console.log('emptytree')
            }
            for (var s = 1; s < 11; s++) {
                addnew = false
                updateparent = false
                updatevalue = false
                valtoparent = []
                valtovalue = []
                var treetmp = tree.filter(stage => stage.id == s)

                var choosetmp = choose.filter(stage => stage.id == s)

                if (choosetmp[0].value.length > 0) {
                    if (emptytree) {
                        addnew = true

                    }
                    for (var i = 0; i < treetmp.length; i++) {
                        var value = new RegExp(treetmp[i].value)
                        var parent = new RegExp(treetmp[i].parent)

                        for (var v = 0; v < choosetmp[0].value.length; v++) {

                            if (value.test(choosetmp[0].value[v])) {
                                for (var p = 0; p < choosetmp[0].parent.length; p++) {
                                    if (parent.test(choosetmp[0].parent[p])) {
                                        break;
                                    }
                                    else {
                                        updateparent = true;
                                        valtoparent.push(choosetmp[0].parent[p])
                                    }
                                }
                            }

                            else if (!value.test(choosetmp[0].value[v])) {
                                for (var p = 0; p < choosetmp[0].parent.length; p++) {
                                    if (parent.test(choosetmp[0].parent[p])) {
                                        updatevalue = true
                                        valtovalue.push(choosetmp[0].value[v])
                                    }
                                    else {
                                        addnew = true;

                                    }
                                }
                            }

                        }
                    }

                    if (addnew) {
                        var valstr = ""
                        var parstr = ''

                        for (var a = 0; a < choosetmp[0].value.length; a++) {
                            valstr += choosetmp[0].value[a] + '|'
                        }
                        choosetmp[0].value = valstr.substring(0, valstr.length - 1)

                        for (var p = 0; p < choosetmp[0].parent.length; p++) {
                            parstr += choosetmp[0].parent[p] + '|'
                        }
                        choosetmp[0].parent = parstr.substring(0, parstr.length - 1)

                        tree.push(choosetmp[0])

                        console.log('add new')
                    }
                    else if (updatevalue) {
                        console.log(valtovalue)
                        var str = ''
                        var uniq = Array.from(new Set(valtovalue))
                        for (var j = 0; j < uniq.length; j++) {
                            str += '|' + uniq[j]

                        }
                        treetmp[0].value += str
                        console.log('update value')
                    }
                    else if (updateparent) {
                        var str = ""
                        var uniq = Array.from(new Set(valtoparent))
                        for (var j = 0; j < uniq.length; j++) {
                            str += '|' + uniq[j]

                        }

                        treetmp[0].parent += str
                        console.log('update parent')
                    }
                }


            }
            docids.map(id => { db.collection("tmp").doc(id).delete() })

            tree.map((stage) => {
                console.log(stage)
                db.collection("tmp").add(stage)
            })

            setTimeout(function () {
                alert('ok')
                location.reload()
            }, 3000);



        }
        function successGetstage(data) {

            console.log(data);
            var result = Object.keys(data);
            for (var i = 1; i <= result.length; i++) {
                for (var j = 0; j < data[i].length; j++) {


                    //$('#stage' + i).append($("<option></option>").val(data[i][j].Description).html(data[i][j].Description));
                    document.getElementById('stage' + i).innerHTML += '<input type="checkbox" value="' + data[i][j].ID + '" />' + data[i][j].Description + '</br>';


                }


            };
        }
        function errorGetstage(err) {
            swal("Error!", err.ExceptionMessage, "error");
        }


    </script>
</head>
<body>
    <div class="container">
        <div class="title">
            <h2>Item List</h2>

        </div>
        <div class="d-flex">

            <div class="wrapper">
                <div class="item"> Model</div>
                <div class="item">Body</div>
                <div class="item">Port</div>
                <div class="item">Function</div>
                <div class="item">Orifice</div>
                <div class="item">Seals</div>
                <div class="item">Override</div>
                <div class="item">Voltage</div>
                <div class="item">Power</div>
                <div class="item">Connector</div>


                <div  id="stage1">

                </div>
                <div  id="stage2">


                </div>
                <div  id="stage3">

                </div>
                <div  id="stage4">


                </div>
                <div  id="stage5">


                </div>
                <div  id="stage6">


                </div>
                <div  id="stage7">


                </div>
                <div  id="stage8">


                </div>
                <div  id="stage9">


                </div>
                <div  id="stage10">

                </div>

            </div>

        </div><!-- Yorder -->

        <div class="fab" onclick=add()> + </div>
    </div>
</body>
</html>